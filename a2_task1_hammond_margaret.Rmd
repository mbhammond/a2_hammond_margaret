---
title: "Palmetto Binary Logistic Regression"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(GGally)
library(broom)
library(caret)
library(AICcmodavg)
library(ggbeeswarm)
library(kableExtra)
library(janitor)
```


## 1. Overview
** GIVE AN OVERVIEW OF THE DATA HERE** 
An overview section describing the data, the question(s) to be addressed in your analysis, and a citation of the dataset.


## 2. Explore the Data

### 2.1 Read and Wrangle the Data

```{r}
palmetto <- read_csv(here("data", "palmetto.csv"))

# species 1 is serenoa repends, species 2 is sabal etonia

# subset of height, length, width, green_lvs

palmetto_sub <- palmetto %>% 
  select(species, height, length, width, green_lvs) %>% 
  mutate(species = case_when(
    species == "1" ~ "0", #serenoa repends now 0
    species == "2" ~ "1" #sabal etonia now 1
  )) %>% 
  drop_na()

palmetto_sub$species <- as.factor(palmetto_sub$species)


class(palmetto_sub$species)
```
### 2.2 Data Visualization
Explore differences in height, canopy length, canopy width, and green leaves for the two species. 
```{r}
height_plot <- ggplot(data = palmetto_sub, aes(x = species, y = height, color = species)) +
  geom_quasirandom(size = 0.5)

ggplot(data = palmetto_sub, aes(x = species, y = length, color = species)) +
  geom_quasirandom(size = 0.5, show.legend = FALSE) +
  labs(x = "Species",
       y = "Length of Canopy",
       title = "Length of Canopy of Palmetto Species", 
       caption = "FLORIDA SOMETHING Length of canopy from 1981 - 2017") 

width_plot <- ggplot(data = palmetto_sub, aes(x = species, y = width, color = species)) +
  geom_quasirandom(size = 0.5)

ggplot(data = palmetto_sub, aes(x = species, y = green_lvs, color = species)) +
  geom_quasirandom(size = 0.5, show.legend = FALSE) +
  labs(x = "Species",
       y = "Count of Green Leaves",
       title = "Amount of Green Leaves on Palmetto Species", 
       caption = "FLORIDA count of green leaves 1981-2017 NEED MORE") 

# length and green_lvs are the most different between the two species
```



## 3. Binary Logistic Regression
A section in which you perform binary logistic regression to determine the probability of a plant being either Serenoa repens or Sabal etonia based on several predictor variables.  Perform the analysis twice, using cross validation to compare two models:
Log odds of plant type using plant height, canopy length, canopy width and green leaves as predictor variable.
Log odds of plant type using plant height, canopy width and green leaves (i.e., drop canopy length for this model) **height, length, width, green_lvs"
Make sure you understand which species is the first ‘0’ factor level, and which is ‘1’ - you may want to convert to a factor first, then use the levels() function to check.  Use repeated cross validation (ten-fold cross validation, repeated at least ten times - you can use functions from the {caret} package to automate this, or manually perform the analysis using for-loops).  Based on the results of the cross validation, describe which model performs better at classification; you may wish to compare AICC values as well to support your decision. 

### 2.1 Create the Binary Logistic Regression Models

```{r}
f1 <- species ~ height + length + width + green_lvs

spec_blr1 <- glm(formula = f1,
                 data = palmetto_sub,
                 family = "binomial")

f2 <- species ~ height + width + green_lvs

spec_blr2 <- glm(formula = f2,
                 data = palmetto_sub,
                 family = "binomial")

class(palmetto_sub$species)
levels(palmetto_sub$species)
# 0 is 0, 1 is 1. Serona is 0.



summary(spec_blr1)
summary(spec_blr2)

blr1_tidy <- tidy(spec_blr1)
blr2_tidy <- tidy(spec_blr2)

aictab(list(spec_blr1, spec_blr2))

```

### 2.2 Use `caret`
```{r}

set.seed(123)

tr_ctrl <- trainControl(method = "repeatedcv",
                        number = 10, repeats = 10)

# Train the model
model1 <- train(f1, data = palmetto_sub,
                method = "glm",
                family = "binomial",
                trControl = tr_ctrl)
#model1

model2 <- train(f2, data = palmetto_sub,
                method = "glm",
                family = "binomial",
                trControl = tr_ctrl)


```
## Table of Model 1
```{r}
spec_blr1_tidy <- tidy(spec_blr1)

# 0 is Serenoa repens
# 1 is Sabal etonia 
spec_blr1_tidy %>% 
  kable(col.names = c("Term",
                      "Estimate",
                      "Standard Error",
                      "Statistic",
                      "P Value"),
        caption = 'Table 1. Binary logistic regression model results for model 1, a model of plant species as a function of height, canopy length, canopy width an green leaves') %>% 
  kable_classic(bootstrap_options = "striped", full_width = FALSE)

```

## Probability Calculations
Use `broom::augment` to find the probabilities for each plant in the original dataset, then add a column for which species your model would classify that plant as (using a 50% cutoff). 

```{r}

# 0 is Serenoa repens
# 1 is Sabal etonia 

spec_blr1_fitted <- spec_blr1 %>% 
  augment(type.predict = "response") %>% 
  mutate(predict_species = case_when(
    .fitted > .5 ~ "Sabal etonia", # probability over .5, higher chance it will be species 1, Sabal etonia
    .fitted < .5 ~ "Serenoa repens" # probability below .5, low chance it is Sabal etonia, assigned to Serenoa repens
  ))

spec_blr1_counts <- spec_blr1_fitted %>% 
  tabyl(species, predict_species)

spec_proportions <- spec_blr1_counts %>% 
  mutate(species = case_when(
    species == "0" ~ "Serenoa repens",
    species == "1" ~ "Sabal etonia")) %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting(digits = 2) %>% 
  adorn_ns()

spec_proportions %>% 
  kable(col.names = c(
    "Species",
    "Probability of Sabal etonia",
    "Probability of Serenoa repens"),
    caption = "Table 2. Probability of correct Sabal etonia and Serenoa repens species as predicted by Model 1.") %>% 
  kable_classic(bootstrap_options = "striped", full_width = FALSE)


```


## Final Reports
A section containing 2 - 3 finalized (customized, suitable for a publication) data visualizations (with figure captions) in which you explore differences in height, canopy length, canopy width, and green leaves for the two species. If you prefer, combine the figures into a compound figure using {patchwork} or {cowplot}. Below your data visualizations, add a sentence or two with a takeaway from the plots, e.g., based on these plots, which predictor variables are more likely to help classify species correctly?

## Data Citation
Abrahamson, W.G. 2019. Survival, growth and biomass estimates of two dominant palmetto species of south-central Florida from 1981 - 2017, ongoing at 5-year intervals ver 1. Environmental Data Initiative. https://doi.org/10.6073/pasta/f2f96ec76fbbd4b9db431c79a770c4d5

